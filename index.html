<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Player Dashboard</title>

<style>
  :root{
    --panel:rgba(17,17,17,.88);
    --border:rgba(255,255,255,.10);
    --text:#fff;
    --muted:rgba(255,255,255,.62);

    /* âœ… CLUB THEME (overridden by page code) */
    --accent:#7B2EFF;
    --accent2:#B266FF;
    --clubGlow: rgba(123,46,255,.18);

    --radius:26px;
  }

  *{box-sizing:border-box}
  body{
    margin:0;background:transparent;color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  }

  .stage{
    min-height:100vh;
    background:
      radial-gradient(1000px 600px at 20% -10%, rgba(255,255,255,.05), transparent 60%),
      linear-gradient(180deg,#000 0%,#050505 100%);
    position:relative;overflow:hidden;
  }
  .stage::before{
    content:"";position:absolute; inset:-40% -20%;
    transform:rotate(-14deg);
    background:linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.05), rgba(255,255,255,0));
    opacity:.18;pointer-events:none;
  }
  .stage::after{
    content:"";position:absolute; inset:0;
    background:radial-gradient(800px 520px at 80% 18%, var(--clubGlow), transparent 62%);
    opacity:.9;pointer-events:none;
    animation:glowPulse 2.8s ease-in-out infinite;
  }
  @keyframes glowPulse{ 0%{opacity:.55} 50%{opacity:1} 100%{opacity:.55} }

  .top{
    position:sticky;top:0;z-index:10;
    backdrop-filter: blur(14px);
    background: rgba(11,13,16,.72);
    border-bottom:1px solid var(--border);
  }
  .topInner{
    max-width:1200px;margin:0 auto;
    padding:16px 20px;
    display:flex;align-items:center;justify-content:space-between;
    position:relative;z-index:2;
  }
  .kicker{font-size:11px;font-weight:900;letter-spacing:1.6px;text-transform:uppercase;}
  .subkicker{margin-top:6px;font-size:12px;color:var(--muted);font-weight:650;}
  .pillTop{
    padding:10px 14px;border:1px solid rgba(255,255,255,.14);border-radius:999px;
    background:rgba(255,255,255,.04);font-size:12px;font-weight:800;
    position:relative;overflow:hidden;
  }
  .pillTop::after{
    content:"";position:absolute;left:12px;right:12px;bottom:8px;height:3px;border-radius:999px;
    background:linear-gradient(90deg, var(--accent), transparent);
    transform:scaleX(.35);transform-origin:left;transition:.18s ease;opacity:.95;
  }
  .pillTop:hover::after{transform:scaleX(1)}

  .page{max-width:1200px;margin:0 auto;padding:34px 20px 80px;position:relative;z-index:2}

  .hero{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:18px;gap:12px;flex-wrap:wrap;}

  .titleRow{
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:14px;
    width:100%;
    flex-wrap:wrap;
  }
  .nameWrap{display:flex;align-items:flex-end;gap:14px;flex-wrap:wrap;}
  .name{
    font-family:Impact,Haettenschweiler,'Arial Narrow Bold',sans-serif;
    font-size:52px;
    text-transform:uppercase;
    letter-spacing:1px;
    line-height:1;
    position:relative;
    padding-bottom:10px;
  }
  .name::after{
    content:"";position:absolute;left:0;bottom:0;height:6px;width:100%;
    border-radius:999px;
    background:linear-gradient(90deg, var(--accent), transparent);
    animation:underlineSweep 1.8s linear infinite;
  }
  @keyframes underlineSweep{
    0%{filter:brightness(1); transform:translateX(-2px)}
    50%{filter:brightness(1.12); transform:translateX(2px)}
    100%{filter:brightness(1); transform:translateX(-2px)}
  }

  .miniStats{
    display:flex;gap:10px;flex-wrap:wrap;
    padding-bottom:8px;
  }
  .miniPill{
    padding:8px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.03);
    color:rgba(255,255,255,.86);
    font-weight:900;
    letter-spacing:.6px;
    text-transform:uppercase;
    font-size:11px;
  }
  .miniPill strong{
    font-family:Impact,Haettenschweiler,'Arial Narrow Bold',sans-serif;
    font-size:14px;
    letter-spacing:.6px;
    margin-left:6px;
    color:#fff;
  }

  .tag{
    padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.04);
    font-size:12px;font-weight:900;letter-spacing:1px;text-transform:uppercase;
    box-shadow:0 0 0 1px rgba(255,255,255,.03), 0 0 24px var(--clubGlow);
    white-space:nowrap;
  }

  .grid{
    display:grid;
    grid-template-columns: 1.35fr 0.65fr;
    gap:14px;
  }
  @media(max-width:980px){ .grid{grid-template-columns:1fr;} }

  .stack{display:grid;gap:14px;}

  .card{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:18px;
    padding:20px;
    position:relative;
    overflow:hidden;
  }
  .card::before{
    content:"";position:absolute; inset:-60% -20%;
    transform:rotate(-12deg);
    background:linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.05), rgba(255,255,255,0));
    opacity:.22;pointer-events:none;
  }
  .cardInner{position:relative;z-index:2}

  .cardStrong{
    box-shadow:0 0 0 1px rgba(255,255,255,.03), 0 0 32px var(--clubGlow);
  }

  .sectionTitle{
    font-family:Impact,Haettenschweiler,'Arial Narrow Bold',sans-serif;
    font-size:18px;
    text-transform:uppercase;
    letter-spacing:.8px;
    margin:0;
    padding-bottom:8px;
    position:relative;
    color:rgba(255,255,255,.92);
  }
  .sectionTitle::after{
    content:"";position:absolute;left:0;bottom:0;height:4px;width:100%;
    border-radius:999px;background:linear-gradient(90deg, var(--accent), transparent);
    transform:scaleX(.35);transform-origin:left;transition:.18s ease;opacity:.95;
  }
  .card:hover .sectionTitle::after{transform:scaleX(1)}

  .subText{margin-top:10px;font-size:13px;color:var(--muted);white-space:pre-wrap;line-height:1.45;}
  .big{margin-top:10px;font-size:28px;font-weight:950;letter-spacing:-1px;}

  .row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;}

  .divider{
    margin:16px 0;
    height:1px;
    background:rgba(255,255,255,.10);
  }

  .btn{
    padding:12px 16px;border-radius:16px;border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.04);
    color:#fff;font-weight:900;letter-spacing:.7px;font-size:12px;text-transform:uppercase;
    cursor:pointer;transition:.14s ease;position:relative;overflow:hidden;
  }
  .btn::after{
    content:"";position:absolute;left:12px;right:12px;bottom:10px;height:4px;border-radius:999px;
    background:linear-gradient(90deg, var(--accent), transparent);
    transform:scaleX(0);transform-origin:left;transition:.18s ease;opacity:.95;
  }
  .btn:hover{
    transform:translateY(-1px);background:rgba(255,255,255,.08);
    border-color:rgba(255,255,255,.18);box-shadow:0 0 28px var(--clubGlow);
  }
  .btn:hover::after{transform:scaleX(1)}
  .btn:active{transform:translateY(0px) scale(.99);}
  .btn:disabled{opacity:.5;cursor:not-allowed;transform:none;}
  .disabled{opacity:.45;pointer-events:none;}

  .schedulePills{display:flex;gap:12px;margin-top:12px;flex-wrap:wrap;}

  .photoRow{display:flex;gap:14px;align-items:center;margin-top:14px;flex-wrap:wrap;}
  .avatarWrap{
    width:110px;height:110px;border-radius:18px;overflow:hidden;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.05);
    box-shadow:0 0 26px var(--clubGlow);
    position:relative;
  }
  .avatar{width:100%;height:100%;object-fit:cover;}
  .badge{
    position:absolute;right:8px;bottom:8px;background:#fff;color:#000;
    padding:5px 8px;border-radius:999px;font-size:10px;font-weight:900;display:none;
  }

  .select{
    width:100%;
    padding:12px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.04);color:#fff;font-weight:800;letter-spacing:.2px;
    outline:none;
  }
  .select option{color:#000;}

  .err{margin-top:14px;color:#fff;background:rgba(255,0,0,.12);border:1px solid rgba(255,0,0,.35);padding:12px;border-radius:14px}

  .toast{
    position:fixed;left:50%;bottom:22px;transform:translateX(-50%);
    background:rgba(0,0,0,.68);border:1px solid rgba(255,255,255,.12);
    padding:12px 14px;border-radius:14px;color:#fff;font-weight:750;font-size:12px;
    backdrop-filter: blur(10px);
    display:none;
    z-index:9999;
  }

  input[type=file]{display:none}
</style>
</head>

<body>
  <div class="stage">

    <div class="top">
      <div class="topInner">
        <div>
          <div class="kicker" id="roleText">ROLE: â€”</div>
          <div class="subkicker" id="clubText">CLUB: â€”</div>
        </div>
        <div class="pillTop" id="todayText">â€”</div>
      </div>
    </div>

    <div class="page">
      <div class="hero">
        <div class="titleRow">
          <div class="nameWrap">
            <div class="name" id="athleteName">LOADING</div>

            <div class="miniStats" aria-label="Player stats">
              <div class="miniPill">JERSEY <strong id="jersey">â€”</strong></div>
              <div class="miniPill">DOB <strong id="dob">â€”</strong></div>
            </div>
          </div>

          <div class="tag">PLAYER OPS</div>
        </div>
      </div>

      <div class="grid">
        <!-- LEFT COLUMN -->
        <div class="stack">

          <!-- âœ… ONE card split into top/bottom halves -->
          <div class="card cardStrong">
            <div class="cardInner">

              <!-- TOP HALF: TEAM -->
              <div class="sectionTitle">Team</div>
              <div class="subText" style="margin-top:10px">
                <span style="font-weight:900;letter-spacing:.6px;text-transform:uppercase;" id="teamName">â€”</span>
              </div>

              <div class="divider"></div>

              <!-- BOTTOM HALF: NEXT EVENT -->
              <div class="sectionTitle">Next Event</div>
              <div class="big" id="eventType">â€”</div>
              <div class="subText" id="eventDetails">â€”</div>

              <div id="error"></div>
            </div>
          </div>

          <!-- Schedule card -->
          <div class="card">
            <div class="cardInner">
              <div class="sectionTitle">Schedule</div>
              <div class="subText" style="margin-top:10px">Open your schedule pages.</div>

              <div class="schedulePills">
                <button class="btn" id="openScheduleListBtn" type="button">Schedule (List)</button>
                <button class="btn" id="openScheduleCalBtn" type="button">Schedule (Calendar)</button>
              </div>
            </div>
          </div>

          <!-- Alert -->
          <div class="card">
            <div class="cardInner">
              <div class="sectionTitle">Club Alert</div>
              <div class="big" id="alertTitle" style="font-size:22px;">â€”</div>
              <div class="subText" id="alertMsg">â€”</div>
            </div>
          </div>

        </div>

        <!-- RIGHT COLUMN -->
        <div class="stack">

          <div class="card cardStrong">
            <div class="cardInner">
              <div class="sectionTitle">Profile</div>

              <div class="photoRow">
                <div class="avatarWrap">
                  <img id="avatar" class="avatar" alt="Player photo"/>
                  <div id="unsavedBadge" class="badge">NEW</div>
                </div>

                <div style="flex:1;min-width:220px;">
                  <div class="row" style="justify-content:flex-start;gap:10px;margin-top:0;flex-wrap:wrap;">
                    <button class="btn" id="viewIdpBtn" type="button">View IDP</button>
                    <button class="btn" id="changePhotoBtn" type="button">Change Photo</button>
                    <button class="btn disabled" id="savePhotoBtn" type="button">Save</button>
                  </div>

                  <div class="subText" style="margin-top:10px">Update photo, view IDP, and switch players (parent mode).</div>
                </div>
              </div>

              <input id="fileInput" type="file" accept="image/*" />

              <div style="margin-top:14px">
                <div class="subText" style="margin:0 0 8px 0">Switch Player</div>
                <select id="kidSelect" class="select" style="display:none;"></select>
              </div>

            </div>
          </div>

        </div>
      </div>

    </div>

    <div class="toast" id="toast"></div>
  </div>

<script>
let state = null;
let pendingDataUrl = null;
let lastSavedUrl = "";

function safe(s){ return String(s ?? "").replace(/[<>]/g,""); }
const $error = document.getElementById("error");
function setError(msg){ $error.innerHTML = msg ? `<div class="err">${safe(msg)}</div>` : ""; }

function post(type, payload = {}) {
  window.parent.postMessage({ type, payload }, "*");
}

/* âœ… THEME APPLY (UNCHANGED) */
function applyTheme(theme){
  const t = theme || {};
  const accent  = String(t.accent  || t.primary || "#7B2EFF").trim();
  const accent2 = String(t.accent2 || accent).trim();
  const glow    = String(t.glow    || t.clubGlow || "rgba(123,46,255,.18)").trim();
  const r = document.documentElement.style;
  r.setProperty("--accent", accent);
  r.setProperty("--accent2", accent2);
  r.setProperty("--clubGlow", glow);
  console.log("ðŸŸª PLAYER DASH THEME APPLIED", { accent, accent2, glow });
}

function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg || "";
  t.style.display = msg ? "block" : "none";
  clearTimeout(window.__tt);
  if(msg) window.__tt = setTimeout(()=>t.style.display="none", 1600);
}

function setDisabled(btnId, disabled){
  const b = document.getElementById(btnId);
  if(!b) return;
  disabled ? b.classList.add("disabled") : b.classList.remove("disabled");
}

function getActivePlayerId(){
  return (state?.activePlayerId || state?.player?.id || "").trim();
}

function render(){
  if(!state) return;

  const p = state.player || {};
  const fullName = ((p.firstName||"")+" "+(p.lastName||"")).trim();
  document.getElementById("athleteName").textContent = (fullName || "ATHLETE").toUpperCase();

  document.getElementById("roleText").textContent = "ROLE: " + (state.role || "â€”");
  document.getElementById("clubText").textContent = "CLUB: " + (state.clubSlug || "â€”");
  document.getElementById("todayText").textContent = state.today || "â€”";

  document.getElementById("teamName").textContent = state.team?.name || "â€”";
  document.getElementById("jersey").textContent = p.jerseyNumber ? "#" + p.jerseyNumber : "â€”";
  document.getElementById("dob").textContent = p.dob || "â€”";

  if (pendingDataUrl) {
    document.getElementById("avatar").src = pendingDataUrl;
  } else if (lastSavedUrl) {
    document.getElementById("avatar").src = lastSavedUrl;
  } else {
    document.getElementById("avatar").src = p.photoUrl || "";
  }

  const evt = state.nextEvent;
  document.getElementById("eventType").textContent = evt ? (evt.type || "EVENT") : "NO EVENT";
  document.getElementById("eventDetails").textContent =
    evt ? `${evt.opponent||""} â€¢ ${evt.date||""} ${evt.time||""}`.trim() : "";

  document.getElementById("alertTitle").textContent = state.alert?.title || "NO ALERTS";
  document.getElementById("alertMsg").textContent = state.alert?.message || "";

  const kids = state.kids || [];
  const sel = document.getElementById("kidSelect");
  if (state.role === "Parent" && kids.length) {
    sel.style.display = "block";
    sel.innerHTML = kids.map(k =>
      `<option value="${k.id}" ${k.id===state.activePlayerId?"selected":""}>${safe(k.name)}</option>`
    ).join("");
  } else {
    sel.style.display = "none";
  }
}

window.addEventListener("message", (e) => {
  const m = e.data || {};
  if (!m) return;

  if (m.type === "THEME") {
    const theme = m.payload?.theme || m.payload || m.theme || null;
    if (theme) applyTheme(theme);
    return;
  }

  if (m.type === "STATE") {
    state = m.payload;

    const theme = state?.theme || null;
    if (theme) applyTheme(theme);

    const cmsUrl = state?.player?.photoUrl || "";
    if (lastSavedUrl && cmsUrl) {
      const baseLast = lastSavedUrl.split("?")[0];
      if (cmsUrl === baseLast) lastSavedUrl = "";
    }

    render();
    return;
  }

  if (m.type === "TOAST") {
    toast(m.payload?.message || "");
    return;
  }

  if (m.type === "PHOTO_SAVED") {
    if (m.payload?.ok) {
      toast("Saved");
      pendingDataUrl = null;

      const url = (m.payload?.url || "").trim();
      if (url) {
        lastSavedUrl = url + (url.includes("?") ? "&" : "?") + "t=" + Date.now();
        if (state?.player) state.player.photoUrl = url;
        document.getElementById("avatar").src = lastSavedUrl;
      }

      setDisabled("savePhotoBtn", true);
      document.getElementById("unsavedBadge").style.display = "none";
    } else {
      toast(m.payload?.message || "Failed");
      setDisabled("savePhotoBtn", false);
    }
  }
});

document.getElementById("viewIdpBtn").onclick = () => post("VIEW_IDP", {});

document.getElementById("kidSelect").onchange = (e) => {
  pendingDataUrl = null;
  lastSavedUrl = "";
  setDisabled("savePhotoBtn", true);
  document.getElementById("unsavedBadge").style.display = "none";
  post("SELECT_KID", { playerId: e.target.value });
};

document.getElementById("changePhotoBtn").onclick = () => {
  document.getElementById("fileInput").click();
};

document.getElementById("fileInput").onchange = (e) => {
  const f = e.target.files && e.target.files[0];
  if (!f) return;

  const r = new FileReader();
  r.onload = () => {
    pendingDataUrl = String(r.result || "");
    document.getElementById("avatar").src = pendingDataUrl;

    setDisabled("savePhotoBtn", false);
    document.getElementById("unsavedBadge").style.display = "block";
  };
  r.readAsDataURL(f);
};

document.getElementById("savePhotoBtn").onclick = () => {
  if (!pendingDataUrl) return;

  const pid = getActivePlayerId();
  if (!pid) return toast("No player selected");

  setDisabled("savePhotoBtn", true);
  toast("Savingâ€¦");
  post("SAVE_PHOTO_DATAURL", { playerId: pid, dataUrl: pendingDataUrl });
};

document.getElementById("openScheduleListBtn")?.addEventListener("click", () => {
  post("OPEN_SCHEDULE_LIST", {});
});
document.getElementById("openScheduleCalBtn")?.addEventListener("click", () => {
  post("OPEN_SCHEDULE_CALENDAR", {});
});

// Handshake
post("IFRAME_READY", {});
</script>
</body>
</html>
